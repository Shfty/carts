pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- entities

entities = {}

---------
-- entity
---------
entity = {
	x = 0,
	y = 0,
	
	s = 0,
	
	sx = 0,
	sy = 0,
	
	vx = 0,
	vy = 0,
	dcc = 0.1,
	
	rad = 4
}

function entity:new(o, c)
	c = c or false

	self.__index = self
	
 setmetatable(
		o or {},
		self
	)
	
	if(c == false) do
		add(entities, o)
	end
	
	return o
end

entity._update = function(self)
	self.x += self.vx
	self.y += self.vy
	
	if abs(self.vx) > self.dcc then
		self.vx += -sgn(self.vx) * self.dcc
	end
	
	if abs(self.vy) >= self.dcc then
		self.vy += -sgn(self.vy) * self.dcc
	end
	
	local mx = self.x/8
	local my = self.y/8
	local s = mget(mx,my)
	if fget(s,2) then
		self.vx -= 1
		self.x -= 1
	end
	if fget(s,3) then
		self.vx += 1
		self.x += 1
	end
	if fget(s,0) then
		self.vy -= 1
		self.y -= 1
	end
	if fget(s,1) then
		self.vy += 1
		self.y += 1
	end
end

entity._draw = function(self)
 local x = self.x
 x -= self.sx
 
 local y = self.y
 y -= self.sy
 
 spr(
 	self.s,
 	flr(x), flr(y)
 )
end

---------
-- player
---------
player = entity:new({
	acc = 0.25,
	dcc = 0.02,
	vmax = 1,
	s = 34,
	sx = 4,
	sy = 4
}, true)

player._update = function(self)
	entity._update(self)
	
	-- x movement
	if(btn(0)) do
		self.vx -= self.acc
	end
	if(btn(1)) do
	 self.vx += self.acc
	end
	
	-- y movement
	if(btn(2)) do
		self.vy -= self.acc
	end
	if(btn(3)) do
		self.vy += self.acc
	end
	
	self.vx = min(self.vx, self.vmax)
	self.vx = max(self.vx, -self.vmax)
	self.vy = min(self.vy, self.vmax)
	self.vy = max(self.vy, -self.vmax)
	
	-- fire bullets
	if(btnp(4)) do
		local b = bullet:new({
		 x = self.x,
		 y = self.y
		})
	end
end

---------
-- bullet
---------
bullet = entity:new({
	s = 5,
	sx = 4,
	sy = 8
}, true)

bullet._update = function(self)
	entity._update(self)
	
	self.y -= 4
	
	if(self.y < 0) do
		del(entities, self)
		self = nil
	end
end

-->8
player:new({
	x = 64,
	y = 104
})

function _update60()
	for e in all(entities) do
		e:_update()
	end
end

function _draw()
	cls()
	map()
	
	for e in all(entities) do
		e:_draw()
	end
end
__gfx__
00000000000000088000000022222228822222222222222882222222000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000822800000022222280082222222222228228222222000000000000000000000000000000000000000000000000000000000000000000000000
00700700000008222280000022222800008222222222282222822222000000000000000000000000000000000000000000000000000000000000000000000000
00077000000082222228000022228000000822222222822222282222000000000000000000000000000000000000000000000000000000000000000000000000
00077000000822222222800022280000000082222228222222228222000000000000000000000000000000000000000000000000000000000000000000000000
00700700008222222222280022800000000008222282222222222822000000000000000000000000000000000000000000000000000000000000000000000000
00000000082222222222228028000000000000822822222222222282000000000000000000000000000000000000000000000000000000000000000000000000
00000000822222222222222880000000000000088222222222222228000000000000000000000000000000000000000000000000000000000000000000000000
22222222888888882222222282222222222222280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222282222222222222280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222282222222222222280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222282222222222222280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222282222222222222280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222282222222222222280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222282222222222222280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222228888888882222222222222280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000bbb30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000bbbbb3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000bb77bb3300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000bb77bb3300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000888888880000bbbbbb3300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00008222222800003bbbb33300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00008222222800000333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00008222222800000033330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00008222222800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00008222222800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00008222222800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00008888888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0005090a060f0f0000000000000000000f01020408000000000000000000000005090000000000000000000000000000060a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1010121210101012121010101212101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1003000013100300000410140000041000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1400000004030000000004030000001300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1400000000000000000000000000001300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1011020000000000000000000001111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010030000000102010200000004101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1003000000010511110602000000041000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1400000000041305061403000000001300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1400000000011306051402000000001300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1002000000040612120503000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010020000000403040300000001101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1012030000000000000000000004121000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1400000000000000000000000000001300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1400000001020000000001020000001300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1002000013100200000110140000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010111110101011111010101111101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
